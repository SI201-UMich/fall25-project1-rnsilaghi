#name: Robert Silaghi
#student ID: 8712 5192
#email: silaghi@umich.edu
#collaborators:

import unittest
import os


def load_data(filename):
    with open(filename, 'r') as fhand:
        file_reader = fhand.readlines()

        if not file_reader:
            return [], [], "", 0

        headers = file_reader[0].rstrip()
        header_list = headers.split(",")

        data_list = []
        for line in file_reader[1:]:
            values = line.rstrip().split(',')
            row_dict = {}
            for header, value in zip(header_list, values):
                if header in ["Yield_tons_per_hectare", "Days_to_Harvest"]:
                    try:
                        row_dict[header] = float(value)
                    except:
                        row_dict[header] = None
                else:
                    row_dict[header] = value
            data_list.append(row_dict)

        if len(file_reader) > 1:
            a_row = file_reader[1].rstrip() 
        else:
            a_row = ""
        count = len(file_reader) - 1

        return header_list, data_list, a_row, count


def region_with_highest_ytp_hectare_for_wheat(data_list):
    max_ytp_wheat_region = None
    max_ytp_wheat = -float('inf')

    for line in data_list:
        crop = line.get("Crop")
        ytp_value = line.get("Yield_tons_per_hectare")

        if crop == "Wheat" and ytp_value is not None:
            try:
                ytp = float(ytp_value)
                if ytp > max_ytp_wheat:
                    max_ytp_wheat = ytp
                    max_ytp_wheat_region = line.get("Region")
            except:
                continue

    if max_ytp_wheat == -float('inf'):
        return None
    return max_ytp_wheat_region


def fert_vs_no_fert_impact_on_dt_harvest_and_ytp_hectare(data_list):
    with_fert_yields = []
    without_fert_yields = []

    for row in data_list:
        ytp_value = row.get("Yield_tons_per_hectare")
        fert_value = row.get("Fertilizer_Used")

        if ytp_value is None or fert_value is None:
            continue

        try:
            ytp = float(ytp_value)
            fert_used = str(fert_value).strip().lower() == "true"

            if fert_used:
                with_fert_yields.append(ytp)
            else:
                without_fert_yields.append(ytp)
        except:
            continue

    result = {}

    if with_fert_yields:
        result["With_Fert"] = round(sum(with_fert_yields) / len(with_fert_yields), 4)
    else:
        result["With_Fert"] = None

    if without_fert_yields:
        result["Without_Fert"] = round(sum(without_fert_yields) / len(without_fert_yields), 4)
    else:
        result["Without_Fert"] = None

    return result


def write_summary_to_txt(filename, summary_text):
    with open(filename, 'w') as f:
        f.write(summary_text)


def main():
    headers, data_list, a_row, count = load_data("crop_yield.csv")

    highest_region = region_with_highest_ytp_hectare_for_wheat(data_list)
    fert_impact = fert_vs_no_fert_impact_on_dt_harvest_and_ytp_hectare(data_list)

    summary_text = f"Highest Wheat Yield Region: {highest_region}\nFertilizer Impact: {fert_impact}"
    write_summary_to_txt("crop_analysis.txt", summary_text)


if __name__ == "__main__":
    main()
    

#Test Cases

class TestLoadData(unittest.TestCase):

    def setUp(self):
        self.test_csv = "test_data.csv"

    def tearDown(self):
        if os.path.exists(self.test_csv):
            os.remove(self.test_csv)

    def test_load_data_general_1(self):
        with open(self.test_csv, 'w') as f:
            f.write("Crop,Yield_tons_per_hectare,Region\nWheat,3.5,North\nCorn,5.0,South")
        headers, data_list, a_row, count = load_data(self.test_csv)
        self.assertEqual(headers, ["Crop", "Yield_tons_per_hectare", "Region"])
        self.assertEqual(count, 2)

    def test_load_data_general_2(self):
        with open(self.test_csv, 'w') as f:
            f.write("Name,Score\nAlice,90\nBob,85")
        headers, data_list, a_row, count = load_data(self.test_csv)
        self.assertEqual(headers, ["Name", "Score"])
        self.assertEqual(data_list[0]["Name"], "Alice")

    def test_load_data_edge_empty_file(self):
        with open(self.test_csv, 'w') as f:
            f.write("")
        headers, data_list, a_row, count = load_data(self.test_csv)
        self.assertEqual(headers, [])
        self.assertEqual(data_list, [])
        self.assertEqual(a_row, "")
        self.assertEqual(count, 0)

    def test_load_data_edge_only_headers(self):
        with open(self.test_csv, 'w') as f:
            f.write("Crop,Yield_tons_per_hectare,Region\n")
        headers, data_list, a_row, count = load_data(self.test_csv)
        self.assertEqual(headers, ["Crop", "Yield_tons_per_hectare", "Region"])
        self.assertEqual(data_list, [])
        self.assertEqual(a_row, "")
        self.assertEqual(count, 0)


class TestRegionWithHighestYield(unittest.TestCase):

    def test_general_1(self):
        data = [
            {"Crop": "Wheat", "Yield_tons_per_hectare": "3.5", "Region": "North"},
            {"Crop": "Wheat", "Yield_tons_per_hectare": "4.2", "Region": "South"},
            {"Crop": "Corn", "Yield_tons_per_hectare": "5.0", "Region": "East"}
        ]
        self.assertEqual(region_with_highest_ytp_hectare_for_wheat(data), "South")

    def test_general_2(self):
        data = [
            {"Crop": "Wheat", "Yield_tons_per_hectare": "2.0", "Region": "West"},
            {"Crop": "Wheat", "Yield_tons_per_hectare": "2.5", "Region": "East"}
        ]
        self.assertEqual(region_with_highest_ytp_hectare_for_wheat(data), "East")

    def test_edge_1(self):
        data = [
            {"Crop": "Corn", "Yield_tons_per_hectare": "5.0", "Region": "North"}
        ]
        self.assertIsNone(region_with_highest_ytp_hectare_for_wheat(data))

    def test_edge_2(self):
        data = [
            {"Crop": "Wheat", "Yield_tons_per_hectare": None, "Region": "South"}
        ]
        self.assertIsNone(region_with_highest_ytp_hectare_for_wheat(data))


class TestFertilizerImpact(unittest.TestCase):

    def test_general_1(self):
        data = [
            {"Yield_tons_per_hectare": "3.0", "Fertilizer_Used": "True"},
            {"Yield_tons_per_hectare": "2.0", "Fertilizer_Used": "False"}
        ]
        result = fert_vs_no_fert_impact_on_dt_harvest_and_ytp_hectare(data)
        self.assertEqual(result["With_Fert"], 3.0)
        self.assertEqual(result["Without_Fert"], 2.0)

    def test_general_2(self):
        data = [
            {"Yield_tons_per_hectare": "4.0", "Fertilizer_Used": "True"},
            {"Yield_tons_per_hectare": "2.0", "Fertilizer_Used": "False"},
            {"Yield_tons_per_hectare": "3.0", "Fertilizer_Used": "False"}
        ]
        result = fert_vs_no_fert_impact_on_dt_harvest_and_ytp_hectare(data)
        self.assertEqual(result["With_Fert"], 4.0)
        self.assertEqual(result["Without_Fert"], 2.5)

    def test_edge_1(self):
        data = [
            {"Yield_tons_per_hectare": "3.0", "Fertilizer_Used": "True"},
            {"Yield_tons_per_hectare": None, "Fertilizer_Used": "False"}
        ]
        result = fert_vs_no_fert_impact_on_dt_harvest_and_ytp_hectare(data)
        self.assertEqual(result["With_Fert"], 3.0)
        self.assertIsNone(result["Without_Fert"])

    def test_edge_2(self):
        data = []
        result = fert_vs_no_fert_impact_on_dt_harvest_and_ytp_hectare(data)
        self.assertIsNone(result["With_Fert"])
        self.assertIsNone(result["Without_Fert"])


class TestWriteSummary(unittest.TestCase):

    def test_general_1(self):
        filename = "test_summary_1.txt"
        content = "This is a test summary."
        write_summary_to_txt(filename, content)
        with open(filename, 'r') as f:
            self.assertEqual(f.read(), content)
        os.remove(filename)

    def test_general_2(self):
        filename = "test_summary_2.txt"
        content = "Another summary with numbers: 12345"
        write_summary_to_txt(filename, content)
        with open(filename, 'r') as f:
            self.assertEqual(f.read(), content)
        os.remove(filename)

    def test_edge_empty_string(self):
        filename = "test_summary_empty.txt"
        content = ""
        write_summary_to_txt(filename, content)
        with open(filename, 'r') as f:
            self.assertEqual(f.read(), "")
        os.remove(filename)

    def test_edge_special_chars(self):
        filename = "test_summary_special.txt"
        content = "!@#$%^&*()_+{}:\"<>?"
        write_summary_to_txt(filename, content)
        with open(filename, 'r') as f:
            self.assertEqual(f.read(), content)
        os.remove(filename)


class TestMainFunction(unittest.TestCase):

    def setUp(self):
        self.test_txt = "crop_analysis.txt"
        self.csv_file = "crop_yield.csv"

    def tearDown(self):
        if os.path.exists(self.test_txt):
            os.remove(self.test_txt)

    def test_main_general_1(self):
        with open(self.csv_file, 'w') as f:
            f.write("Crop,Yield_tons_per_hectare,Region,Fertilizer_Used\n")
            f.write("Wheat,4.0,East,True\n")
            f.write("Corn,3.0,West,False\n")
        main()
        with open(self.test_txt, 'r') as f:
            content = f.read()
            self.assertIn("Highest Wheat Yield Region: East", content)
            self.assertIn("Fertilizer Impact", content)

    def test_main_general_2(self):
        with open(self.csv_file, 'w') as f:
            f.write("Crop,Yield_tons_per_hectare,Region,Fertilizer_Used\n")
            f.write("Wheat,2.0,North,False\n")
            f.write("Wheat,3.0,South,True\n")
        main()
        with open(self.test_txt, 'r') as f:
            content = f.read()
            self.assertIn("Highest Wheat Yield Region: South", content)
            self.assertIn("Fertilizer Impact", content)

    def test_main_edge_empty_file(self):
        with open(self.csv_file, 'w') as f:
            f.write("")
        main()
        with open(self.test_txt, 'r') as f:
            content = f.read()
            self.assertIn("Highest Wheat Yield Region: None", content)

    def test_main_edge_missing_values(self):
        with open(self.csv_file, 'w') as f:
            f.write("Crop,Yield_tons_per_hectare,Region,Fertilizer_Used\n")
            f.write("Wheat,,East,True\n")
            f.write("Corn,3.0,West,\n")
        main()
        with open(self.test_txt, 'r') as f:
            content = f.read()
            self.assertIn("Fertilizer Impact", content)


if __name__ == "__main__":
    unittest.main()